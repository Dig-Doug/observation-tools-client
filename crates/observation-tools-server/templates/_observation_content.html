{% from "_json_value.html" import render_json %}
<div class="flex flex-col h-full">
  <div class="flex-shrink-0">
    <h1 class="text-2xl font-bold my-4">{{ observation.name }}</h1>

    <p class="mb-2">
      <span class="text-base-content/60 text-sm">id:</span>
      <kbd data-testid="ObservationId" class="kbd kbd-sm">{{ observation.id }}</kbd>
    </p>
    <p class="mb-2">
      <span class="text-base-content/60 text-sm">created:</span>
      {{ observation.created_at }}
    </p>

    {% if observation.source %}
      <p class="mb-2">
        <span class="text-base-content/60 text-sm">source:</span>
        <kbd class="kbd kbd-sm"
          ><span data-testid="ObservationSourceFile">{{ observation.source.file }}</span>:<span
            data-testid="ObservationSourceLine"
            >{{ observation.source.line }}</span
          ></kbd
        >
      </p>
    {% endif %}
    {% if observation.parent_span_id %}
      <p class="mb-2">
        <span class="text-base-content/60 text-sm">parent span:</span>
        <kbd class="kbd kbd-sm">{{ observation.parent_span_id }}</kbd>
      </p>
    {% endif %}
    {% if observation.group_ids %}
      <p data-testid="ObservationGroups" class="mb-2">
        <span class="text-base-content/60 text-sm">groups:</span>
        {{ observation.group_ids|join(", ") }}
      </p>
    {% endif %}
    {% if observation.metadata %}
      <h3 data-testid="ObservationMetadataHeader" class="text-base font-bold my-2">metadata</h3>
      <ul data-testid="ObservationMetadata" class="list-none">
        {% for item in observation.metadata | items %}
          <li data-testid="ObservationMetadataItem" class="my-2">
            <span data-testid="ObservationMetadataKey">{{ item[0] }}</span>:
            <span data-testid="ObservationMetadataValue">{{ item[1] }}</span>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    <div class="divider"></div>

    <h2 class="text-xl font-bold my-4">payloads</h2>
  </div>

  {% for payload in observation.payloads %}
    <div class="mb-4">
      <h3 class="text-base font-bold my-2">{{ payload.name }}</h3>
      <p class="mb-2">
        <span class="text-base-content/60 text-sm">type:</span>
        {{ payload.mime_type }}
        <span class="text-base-content/60 text-sm ml-2">size:</span>
        {{ payload.size }} bytes
      </p>
      <p class="mb-2">
        <a
          href="/api/exe/{{ observation.execution_id }}/obs/{{ observation.id }}/payload/{{ payload.id }}/content"
          target="_blank"
          rel="noopener noreferrer"
          class="link"
          >Open raw content in new tab</a
        >
      </p>

      {% if payload.size > display_threshold %}
        <div class="flex-grow">
          <p data-testid="ObservationPayload">Payload is too large to display inline.</p>
        </div>
      {% elif payload.data.Markdown is defined %}
        <div data-testid="ObservationPayload" class="markdown-body">
          {{ payload.data.Markdown.raw|render_markdown|safe }}
        </div>
      {% elif payload.data.Json is defined %}
        <div data-testid="ObservationPayload" class="json-body">
          {{ render_json(payload.data.Json) }}
        </div>
      {% elif payload.data.Text is defined %}
        <pre data-testid="ObservationPayload">{{ payload.data.Text|unescape }}</pre>
      {% elif payload.data.Pointer is defined %}
        <div data-testid="ObservationPayload">
          <p class="mb-2">Payload stored externally.</p>
          <a href="{{ payload.data.Pointer.url }}" target="_blank" class="link"
            >Load external content</a
          >
        </div>
      {% elif payload.data.InlineBinary is defined %}
        <pre data-testid="ObservationPayload">
[Binary content - {{ payload.size }} bytes]</pre
        >
      {% else %}
        <pre data-testid="ObservationPayload">[Unknown payload type]</pre>
      {% endif %}
    </div>
  {% endfor %}
</div>
